#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e
# fail if pipe to indent fails
set -o pipefail

BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`
BUILD_DIR=$1
CACHE_DIR=$2

SITE_DIR=$CACHE_DIR/site
OUTPUT_DIR=$CACHE_DIR/site/output
GEM_DIR=$CACHE_DIR/vendor/bundle

indent() { sed 's/^/  /'; }

# include .files when moving things around
shopt -s dotglob

export HOME=/app

cd "${HOME}"

if [[ -d ".profile.d" ]]; then
  for file in .profile.d/*; do
    source "${file}"
  done
fi

# Reset shell hash tables so the path to executable is not cached
hash -r

cd $BUILD_DIR

echo "-----> Installing gems for nanoc site"

bundle install

echo "-----> Compiling nanoc site"

# go go gadget nanoc!
bundle exec nanoc compile | indent

# and copy it back
cp -r $OUTPUT_DIR $BUILD_DIR/output

# set up nanoc config
cat << EOF >> $BUILD_DIR/static.json
{
  "root": "output/"
}
EOF
