#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e
# fail if pipe to indent fails
set -o pipefail

BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`
BUILD_DIR=$1
CACHE_DIR=$2

SITE_DIR=$CACHE_DIR/site
OUTPUT_DIR=$CACHE_DIR/site/output
GEM_DIR=$CACHE_DIR/vendor/bundle

# include .files when moving things around
shopt -s dotglob

cd $BUILD_DIR

source "/app/.profile.d/ruby.sh"

echo "-----> Installing gems for nanoc site"

bundle install

echo "-----> Compiling nanoc site"

# go go gadget nanoc!
bundle exec nanoc compile | indent

# and copy it back
cp -r $OUTPUT_DIR $BUILD_DIR/output

# set up nanoc config
cat << EOF >> $BUILD_DIR/static.json
{
  "root": "output/"
}
EOF
